# 积分管理系统 - 快速启动指南

## 🚀 快速启动

### 1. 启动后端服务器

```bash
cd backend
python server.py
```

后端将在 `http://localhost:8000` 启动

### 2. 启动前端开发服务器

```bash
cd frontend
npm start
```

前端将在 `http://localhost:3000` 启动

### 3. 访问管理页面

1. 使用管理员账户登录
2. 点击右上角的"管理"按钮
3. 切换到"积分管理"标签页

## 📊 功能测试

### 测试1：查看积分统计

1. 进入"积分管理"标签页
2. 查看4个统计卡片：
   - ✅ 累计充值（绿色）
   - ✅ 累计查询消耗（红色）
   - ✅ 今日查询消耗（橙色）
   - ✅ 累计奖励（蓝色）

### 测试2：查看交易记录

1. 在积分管理页面向下滚动
2. 查看"积分交易记录"表格
3. 验证显示的字段：
   - 时间
   - 用户
   - 变动（+/-）
   - 类型（充值/消耗/奖励/扣除）
   - 原因
   - 余额
   - 操作人

### 测试3：用户查询扣费

1. 使用普通用户账户登录
2. 执行一次邮箱或电话查询
3. 观察积分减少1
4. 切换到管理员账户
5. 查看积分管理 > 交易记录
6. 验证新增了一条"消耗"记录

### 测试4：管理员充值

1. 登录管理员账户
2. 进入"用户管理"标签页
3. 找到一个用户，点击"充值"按钮
4. 输入充值金额（如：10）
5. 确认充值成功
6. 切换到"积分管理"标签页
7. 验证：
   - 累计充值数字增加
   - 交易记录中出现新的"充值"记录
   - 操作人显示为管理员用户名

### 测试5：管理员扣费

1. 登录管理员账户
2. 进入"用户管理"标签页
3. 找到一个用户，点击"扣费"按钮
4. 输入扣除金额（如：5）
5. 确认扣费成功
6. 切换到"积分管理"标签页
7. 验证交易记录中出现"扣除"记录

### 测试6：管理员无限积分

1. 登录管理员账户
2. 执行多次查询（邮箱或电话）
3. 验证积分不减少
4. 查看交易记录，确认没有创建consumption记录

### 测试7：数据刷新

1. 在积分管理页面
2. 点击右上角的"刷新数据"按钮
3. 观察加载动画
4. 验证数据更新

## 🎯 预期结果

### 初始状态（无交易记录）
- 累计充值：0
- 累计查询消耗：0
- 今日查询消耗：0
- 累计奖励：0
- 交易记录：暂无交易记录

### 执行查询后
- 累计查询消耗：+1
- 今日查询消耗：+1
- 交易记录：新增1条consumption记录

### 管理员充值后
- 累计充值：+充值金额
- 交易记录：新增1条recharge记录，operator显示管理员用户名

## 🔍 数据验证

### 检查数据库

```bash
cd backend
sqlite3 osint_tracker.db
```

```sql
-- 查看交易记录表
SELECT * FROM points_transactions ORDER BY created_at DESC LIMIT 10;

-- 查看统计数据
SELECT 
  transaction_type,
  COUNT(*) as count,
  SUM(amount) as total_amount
FROM points_transactions
GROUP BY transaction_type;

-- 查看今日消耗
SELECT 
  COUNT(*) as today_queries,
  SUM(amount) as today_consumption
FROM points_transactions
WHERE transaction_type = 'consumption'
  AND DATE(created_at) = DATE('now');
```

## 🐛 常见问题

### 问题1：统计数据显示为0

**原因：** 数据库中还没有交易记录

**解决：** 执行几次查询或充值操作来生成数据

### 问题2：交易记录不显示

**原因：** 
- API调用失败
- 数据库表未创建

**解决：**
1. 检查后端日志
2. 运行 `python backend/models.py` 初始化数据库
3. 检查浏览器控制台错误

### 问题3：管理员查询仍然扣费

**原因：** 用户不是管理员或session过期

**解决：**
1. 确认用户is_admin=true
2. 重新登录
3. 检查后端日志中的"Admin user"消息

### 问题4：充值后统计不更新

**原因：** 前端缓存

**解决：** 点击"刷新数据"按钮

## 📝 API端点参考

### 积分统计
```
GET /api/admin/points/stats?session_token={token}
```

### 交易记录
```
GET /api/admin/points/transactions?session_token={token}&limit=10&offset=0
```

### 查询日志
```
GET /api/admin/logs/queries?session_token={token}&limit=50&offset=0
```

## 🎨 UI截图说明

### 积分管理页面布局：

```
┌─────────────────────────────────────────────────────────┐
│  积分管理                          [刷新数据]            │
│  查询消耗、充值与积分统计                                │
├─────────────────────────────────────────────────────────┤
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│  │累计充值  │ │累计消耗  │ │今日消耗  │ │累计奖励  │  │
│  │  1000    │ │   500    │ │   50     │ │   100    │  │
│  │(绿色)    │ │(红色)    │ │(橙色)    │ │(蓝色)    │  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘  │
├─────────────────────────────────────────────────────────┤
│  积分交易记录                      最近 10 条            │
│  ┌───────────────────────────────────────────────────┐ │
│  │时间 │用户│变动│类型│原因│余额│操作人│              │ │
│  ├───────────────────────────────────────────────────┤ │
│  │...  │... │-1  │消耗│查询│99  │system│              │ │
│  │...  │... │+10 │充值│充值│109 │admin │              │ │
│  └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

## ✅ 验收标准

- [x] 积分统计数据正确显示
- [x] 交易记录完整记录
- [x] 用户查询扣除1积分
- [x] 管理员充值创建交易记录
- [x] 管理员查询不扣费
- [x] 今日消耗单独统计
- [x] 刷新功能正常
- [x] 颜色编码清晰
- [x] 操作人正确记录

## 🎉 完成！

积分管理统计功能已全部实现并可以使用。如有问题，请查看：
- 后端日志：backend/backend.log
- 浏览器控制台
- 数据库文件：backend/osint_tracker.db
